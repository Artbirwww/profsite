import { useState, useEffect } from 'react';
import { SimpleButton as Button } from './SimpleButton';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from './SimpleUI';
import { ArrowLeft, Clock } from './SimpleIcons';
import type { User, TestResult } from '../App';

interface EngineeringThinkingTestProps {
  user: User;
  onComplete: (result: Partial<TestResult>) => void;
  onBack: () => void;
}

// Ключ правильных ответов (индексы начинаются с 0)
const answerKey = [
  2, 2, 1, 3, 2, 2, 3, 3, 2, 3, 2, 2, 3, 3, 2, 2, 2, 3, 2, 3,
  2, 1, 3, 3, 2, 2, 1, 3, 2, 1, 3, 2, 1, 3, 1, 3, 2, 3, 1, 2,
  1, 2, 3, 1, 3, 1, 1, 1, 2, 3, 2, 1, 2, 1, 1, 2, 1, 1, 2, 1,
  2, 1, 3, 2, 1, 2, 3, 1, 2, 1
];

// Вопросы теста
const questions = [
  { q: 'Если левая шестерня поворачивается в указанном стрелкой направлении, то в каком направлении будет поворачиваться правая шестерня?', a: ['В направлении стрелки А.', 'В направлении стрелки В.', 'Не знаю'] },
  { q: 'Какая гусеница должна двигаться быстрее, чтобы трактор поворачивался в указанном стрелкой направлении?', a: ['Гусеница А.', 'Гусеница В.', 'Не знаю.'] },
  { q: 'Если верхнее колесо вращается в направлении, указанном стрелкой, то в каком направлении вращается нижнее колесо?', a: ['В направлении А.', 'В обоих направлениях.', 'В направлении В.'] },
  { q: 'В каком направлении будет двигаться зубчатое колесо, если ручку слева двигать вниз и вверх в направлении пунктирных стрелок?', a: ['Вперед-назад по стрелкам А-В.', 'В направлении стрелки А.', 'В направлении стрелки В.'] },
  { q: 'Если на круглый диск, указанный на рисунке, действуют одновременно две одинаковые силы 1 и 2, то в каком направлении будет двигаться диск?', a: ['В направлении, указанном стрелкой А.', 'В направлении стрелки В.', 'В направлении стрелки С.'] },
  { q: 'Нужны ли обе цепи, изображенные на рисунке, для поддержки груза, или достаточно только одной? Какой?', a: ['Достаточно цепи А.', 'Достаточно цепи В.', 'Нужны обе цепи.'] },
  { q: 'В речке, где вода течет в направлении, указанном стрелкой, установлены три турбины. Из труб над ними падает вода. Какая из турбин будет вращаться быстрее?', a: ['Турбина А.', 'Турбина В.', 'Турбина С.'] },
  { q: 'Какое из колес, А или В, будет вращаться в том же направлении, что и колесо X?', a: ['Колесо А.', 'Колесо В.', 'Оба колеса.'] },
  { q: 'Какая цепь нужна для поддержки груза?', a: ['Цепь А.', 'Цепь В.', 'Цепь С.'] },
  { q: 'Какая из шестерен вращается в том же направлении, что и ведущая шестерня? А может быть, в этом направлении не вращается ни одна из шестерен?', a: ['Шестерня А.', 'Шестерня В.', 'Не вращается ни одна.'] },
  { q: 'Какая из осей, А или В, вращается быстрее или обе оси вращаются с одинаковой скоростью?', a: ['Ось А вращается быстрее.', 'Ось В вращается быстрее.', 'Обе оси вращаются с одинаковой скоростью.'] },
  { q: 'Если нижнее колесо вращается в направлении, указанном стрелкой, то в каком направлении будет вращаться ось X?', a: ['В направлении стрелки А.', 'В направлении стрелки В.', 'В том и другом направлениях.'] },
  { q: 'Какая из машин с жидкостью в бочке тормозит?', a: ['Машина А.', 'Машина B.', 'Машина C.'] },
  { q: 'В каком направлении будет вращаться вертушка, приспособленная для полива, если в нее пустить воду под напором?', a: ['В обе стороны.', 'В направлении стрелки А.', 'В направлении стрелки В'] },
  { q: 'Какая из рукояток будет держаться под напряжением пружины?', a: ['Не будут держаться обе.', 'Будет держаться рукоятка А.', 'Будет держаться рукоятка В.'] },
  { q: 'В каком направлении передвигали кровать в последний раз?', a: ['В направлении стрелки А.', 'В направлении стрелки В.', 'Не знаю.'] },
  { q: 'Колесо и тормозная колодка изготовлены из одного и того же материала. Что быстрее износится: колесо или колодка?', a: ['Колесо износится быстрее.', 'Колодка износится быстрее.', 'И колесо, и колодка износятся одинаково.'] },
  { q: 'Одинаковой ли плотности жидкостями заполнены емкости или одна из жидкостей более плотная, чем другая (шары одинаковые)?', a: ['Обе жидкости одинаковые по плотности.', 'Жидкость А плотнее.', 'Жидкость В плотнее.'] },
  { q: 'В каком направлении будет вращаться вентилятор под напором воздуха?', a: ['В направлении стрелки А.', 'В направлении стрелки В.', 'В том и другом направлениях.'] },
  { q: 'В каком положении остановится диск после свободного движения по указанной линии?', a: ['В каком угодно.', 'В положении А.', 'В положении В.'] },
  { q: 'Какими ножницами легче резать лист железа?', a: ['Ножницами А.', 'Ножницами В.', 'Ножницами С.'] },
  { q: 'Какое колесо кресла-коляски вращается быстрее при движении коляски?', a: ['Колесо А вращается быстрее.', 'Оба колеса вращаются с одинаковой скоростью.', 'Колесо В вращается быстрее.'] },
  { q: 'Как будет изменяться форма запаянной тонкостенной жестяной банки, если ее нагревать?', a: ['Как показано на рисунке А.', 'Как показано на рисунке В.', 'Как показано на рисунке С.'] },
  { q: 'Какая из шестерен вращается быстрее?', a: ['Шестерня А.', 'Шестерня В.', 'Шестерня С.'] },
  { q: 'С каким шариком столкнется шарик X, если его ударить о преграду в направлении, указанном сплошной стрелкой?', a: ['С шариком А.', 'С шариком В.', 'С шариком С.'] },
  { q: 'Допустим, что нарисованные колеса изготовлены из резины, В каком направлении нужно вращать ведущее колесо (левое), чтобы колесо Х вращалось в направлении, указанном пунктирной стрелкой?', a: ['В направлении стрелки А.', 'В направлении стрелки В.', 'Направление не имеет значения.'] },
  { q: 'Если первая шестерня вращается в направлении, указанном стрелкой, то в каком направлении вращается верхняя шестерня?', a: ['В направлении стрелки А.', 'В направлении стрелки В.', 'Не знаю.'] },
  { q: 'Вес фигур А, В и С одинаковый. Какую из них труднее опрокинуть?', a: ['Фигуру А.', 'Фигуру В.', 'Фигуру С.'] },
  { q: 'Какими кусочками льда можно быстрее охладить стакан воды?', a: ['Куском на картинке А.', 'Кусочками на картинке В.', 'Куском на картинке С.'] },
  { q: 'На какой картинке правильно изображено падение бомбы из самолета?', a: ['На картинке А.', 'На картинке В.', 'На картинке С.'] },
  { q: 'В какую сторону занесет эту машину, движущуюся по стрелке, на повороте?', a: ['В любую сторону.', 'В сторону А.', 'В сторону В.'] },
  { q: 'В емкости находится лед. Как изменится уровень воды по сравнению с уровнем льда после его таяния?', a: ['Уровень повысится.', 'Уровень понизится.', 'Уровень не изменится.'] },
  { q: 'Какой из камней, А или В, легче двигать?', a: ['Камень А.', 'Усилия должны быть одинаковыми.', 'Камень В.'] },
  { q: 'Какая из осей вращается медленнее?', a: ['Ось А.', 'Ось В.', 'Ось С.'] },
  { q: 'Одинаков ли вес обоих ящиков или один из них легче?', a: ['Ящик А легче.', 'Ящик В легче.', 'Ящики одинакового веса.'] },
  { q: 'Бруски А и В имеют одинаковые сечения и изготовлены из одного и того же материала. Какой из брусков может выдержать больший вес?', a: ['Оба выдержат одинаковую нагрузку.', 'Брусок А.', 'Брусок В.'] },
  { q: 'На какую высоту поднимется вода из шланга, если ее выпустить из резервуаров А и В, заполненных доверху?', a: ['Как показано на рисунке А.', 'Как показано на рисунке В.', 'До высоты резервуаров.'] },
  { q: 'Какой из этих цельнометаллических предметов охладится быстрее, если их вынести горячими на воздух?', a: ['Предмет А.', 'Предмет В.', 'Предмет С.'] },
  { q: 'В каком положении остановится деревянный диск со вставленным в него металлическим кружком, если диск катнуть?', a: ['В положении А.', 'В положении В.', 'В любом положении.'] },
  { q: 'В каком месте переломится палка, если резко нажать на ее конец слева?', a: ['В месте А.', 'В месте В.', 'В месте С.'] },
  { q: 'На какой емкости правильно нанесены риски, обозначающие равные объемы?', a: ['На емкости А.', 'На емкости В.', 'На емкости С.'] },
  { q: 'На каком из рисунков правильно изображена вода, выливающаяся из отверстий сосуда?', a: ['На рисунке А.', 'На рисунке В.', 'На рисунке С.'] },
  { q: 'В каком пакете мороженое растает быстрее?', a: ['В пакете А.', 'В пакете В.', 'Одинаково.'] },
  { q: 'Как будет двигаться подвешенный груз, если верхнее колесо вращается в направлении стрелки?', a: ['Прерывисто вниз.', 'Прерывисто вверх.', 'Непрерывно вверх.'] },
  { q: 'Какое из колес, изготовленных из одинакового материала, будет вращаться дольше, если их раскрутить до одинаковой скорости?', a: ['Колесо А.', 'Колесо В.', 'Колесо С.'] },
  { q: 'Каким способом легче везти камень по гладкой дороге?', a: ['Способом А.', 'Способом В.', 'Способом С.'] },
  { q: 'В каком направлении будет двигаться вода в системе шестерёнчатого насоса, если его шестерня вращается в направлении стрелок?', a: ['В сторону А.', 'В сторону В.', 'В обе стороны.'] },
  { q: 'При каком виде передачи подъем в гору на велосипеде тяжелее?', a: ['При передаче типа А.', 'При передаче типа В.', 'При передаче типа С.'] },
  { q: 'На дне емкости находится песок. Поверх него — галька (камешки). Как изменится уровень насыпки в емкости, если гальку и песок перемешать?', a: ['Уровень повысится.', 'Уровень понизится.', 'Уровень останется прежним.'] },
  { q: 'Зубчатая рейка Х двигается полметра в указанном стрелкой направлении. На какое расстояние при этом переместится центр шестерни?', a: ['На 0,16м.', 'На 0,25м.', 'На 0,5 м.'] },
  { q: 'Какая из шестерен, А или В, вращается медленнее, или они вращаются с одинаковой скоростью?', a: ['Шестерня А вращается медленнее.', 'Обе шестерни вращаются с одинаковой скоростью.', 'Шестерня В вращается медленнее.'] },
  { q: 'Какая из лошадок должна бежать на повороте быстрее для того, чтобы ее не обогнала другая?', a: ['Лошадка А.', 'Обе должны бежать с одинаковой скоростью.', 'Лошадка В.'] },
  { q: 'Из какого крана сильнее должна бить струя воды, если их открыть одновременно?', a: ['Из крана А.', 'Из крана В.', 'Из обоих одинаково.'] },
  { q: 'В каком случае легче поднять одинаковый по весу груз?', a: ['В случае А.', 'В случае В.', 'В обоих случаях одинаково.'] },
  { q: 'Эти тела сделаны из одного и того же материала. Какое из них имеет меньший вес?', a: ['Тело А.', 'Тело В.', 'Оба тела одинаковы по весу.'] },
  { q: 'В какой точке шарик двигается быстрее?', a: ['В обоих точках, А и В, скорость одинаковая.', 'В точке А скорость больше.', 'В точке В скорость больше.'] },
  { q: 'Какой из двух рельсов должен быть выше на повороте?', a: ['Рельс А.', 'Рельс В.', 'Оба рельса должны быть одинаковыми по высоте.'] },
  { q: 'Как распределяется вес между крюками А и В?', a: ['Сила тяжести на обоих крюках одинаковая.', 'На крюке А сила тяжести больше', 'На крюке В сила тяжести больше.'] },
  { q: 'Клапаны какого насоса находятся в правильном положении?', a: ['Насоса А.', 'Насоса В.', 'Насоса С.'] },
  { q: 'Какая из осей вращается медленнее?', a: ['Ось А.', 'Ось В.', 'Ось С.'] },
  { q: 'Материал и сечения тросов А и В одинаковые. Какой из них выдержит большую нагрузку?', a: ['Трос А.', 'Трос В.', 'Оба троса выдержат одинаковую нагрузку.'] },
  { q: 'Какой из тракторов должен отъехать дальше для того, чтобы лодки остановились у берега?', a: ['Трактор А.', 'Трактор В.', 'Оба трактора должны отъехать на одинаковое расстояние.'] },
  { q: 'У какой из калиток трос поддержки закреплен лучше?', a: ['У обоих калиток закреплен одинаково хорошо.', 'У калитки А закреплен лучше.', 'У калитки В закреплен лучше.'] },
  { q: 'Какой талью легче поднять груз?', a: ['Талью А.', 'Талью В.', 'Обеими талями одинаково.'] },
  { q: 'На оси Х находится ведущее колесо, вращающее конусы. Какой из них будет вращаться быстрее?', a: ['Конус А.', 'Оба конуса будут вращаться одинаково.', 'Конус В.'] },
  { q: 'Если маленькое колесо будет вращаться в направлении, указанном стрелкой, то как будет вращаться большое колесо?', a: ['В направлении стрелки А.', 'В обе стороны.', 'В направлении стрелки В.'] },
  { q: 'Какой из тросов удерживает столб надежнее?', a: ['Трос А.', 'Трос В.', 'Трос С.'] },
  { q: 'Какой из лебедок труднее поднимать груз?', a: ['Лебедкой А.', 'Обеими лебедками одинаково.', 'Лебедкой В.'] },
  { q: 'Если необходимо поддержать стальным тросом построенный через реку мост, то как целесообразнее закрепить трос?', a: ['Как показано на рис. А.', 'Как показано на рис. В.', 'Как показано на рис. С.'] },
  { q: 'Какая из цепей менее напряжена?', a: ['Цепь А.', 'Цепь В.', 'Обе цепи напряжены одинаково.'] }
];

export function EngineeringThinkingTest({ user, onComplete, onBack }: EngineeringThinkingTestProps) {
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [selectedAnswers, setSelectedAnswers] = useState<number[]>(Array(70).fill(0));
  const [remainingTime, setRemainingTime] = useState(1500); // 25 минут в секундах
  const [isCompleted, setIsCompleted] = useState(false);

  // Таймер обратного отсчета
  useEffect(() => {
    if (isCompleted || remainingTime <= 0) return;
    
    const interval = setInterval(() => {
      setRemainingTime(prev => {
        if (prev <= 1) {
          // Время вышло
          completeTest();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);
    
    return () => clearInterval(interval);
  }, [isCompleted, remainingTime]);

  // Форматирование времени
  const formatTime = (seconds: number) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // Подсчет правильных ответов
  const calculateScore = () => {
    let score = 0;
    selectedAnswers.forEach((answer, index) => {
      if (answer > 0 && answer === answerKey[index]) {
        score++;
      }
    });
    return score;
  };

  // Выбор ответа
  const handleAnswerSelect = (answerNumber: number) => {
    const newAnswers = [...selectedAnswers];
    newAnswers[currentQuestion] = answerNumber;
    setSelectedAnswers(newAnswers);
  };

  // Навигация
  const handleNext = () => {
    if (currentQuestion < 69) {
      setCurrentQuestion(currentQuestion + 1);
    }
  };

  const handlePrevious = () => {
    if (currentQuestion > 0) {
      setCurrentQuestion(currentQuestion - 1);
    }
  };

  // Завершение теста
  const completeTest = () => {
    setIsCompleted(true);
    const score = calculateScore();
    
    // Формируем результат
    const engineeringResult: { [key: string]: number } = {
      'Правильных ответов': score,
      'Всего вопросов': 70,
      'Процент': Math.round((score / 70) * 100),
      'Затраченное время (сек)': 1500 - remainingTime
    };

    onComplete({
      engineeringThinking: engineeringResult
    });
  };

  // Подсчет отвеченных вопросов
  const answeredCount = selectedAnswers.filter(a => a > 0).length;

  if (isCompleted) {
    const score = calculateScore();
    
    return (
      <div className="min-h-screen p-4 py-8 flex items-center justify-center">
        <Card className="max-w-2xl w-full">
          <CardHeader>
            <CardTitle className="text-center">Тест завершен!</CardTitle>
            <CardDescription className="text-center">
              Затраченное время: {formatTime(1500 - remainingTime)}
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="p-6 bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl">
                <div className="text-center">
                  <div className="text-6xl font-medium text-green-600 mb-2">{score}</div>
                  <div className="text-gray-600">из 70 правильных ответов</div>
                  <div className="text-2xl text-green-700 mt-2">{Math.round((score / 70) * 100)}%</div>
                </div>
              </div>
              <Button onClick={onBack} className="w-full">
                Вернуться в личный кабинет
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  const currentQ = questions[currentQuestion];

  return (
    <div className="min-h-screen p-4 py-8">
      <div className="max-w-4xl mx-auto space-y-6">
        {/* Header */}
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Button variant="outline" onClick={onBack}>
                  <ArrowLeft className="size-4" />
                </Button>
                <div>
                  <CardTitle>Инженерное мышление</CardTitle>
                  <CardDescription>Тест технических способностей</CardDescription>
                </div>
              </div>
              <div className="flex items-center gap-2">
                <Clock className="size-5 text-gray-600" />
                <span className={`text-lg ${remainingTime < 300 ? 'text-red-600' : 'text-gray-600'}`}>
                  {formatTime(remainingTime)}
                </span>
              </div>
            </div>
          </CardHeader>
        </Card>

        {/* Disclaimer */}
        <Card className="bg-blue-50 border-blue-200">
          <CardContent className="pt-6">
            <p className="text-gray-700">
              Вам необходимо выбрать и указать правильный ответ. На общее выполнение всех заданий отводится 25 минут. Допускается выполнение заданий в любой последовательности.
            </p>
          </CardContent>
        </Card>

        {/* Progress */}
        <div className="flex items-center justify-between text-sm text-gray-600">
          <span>Вопрос {currentQuestion + 1} из 70</span>
          <span>Отвечено: {answeredCount} / 70</span>
        </div>

        {/* Question */}
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">
              {currentQuestion + 1}) {currentQ.q}
            </CardTitle>
          </CardHeader>
          <CardContent>
            {/* Image placeholder */}
            <div className="mb-6 p-8 bg-gray-100 rounded-xl border-2 border-dashed border-gray-300 text-center text-gray-500">
              Изображение к вопросу {currentQuestion + 1}
            </div>

            {/* Answer options */}
            <div className="space-y-3">
              {currentQ.a.map((answer, idx) => (
                <button
                  key={idx}
                  onClick={() => handleAnswerSelect(idx + 1)}
                  className={`w-full p-4 text-left rounded-xl border-2 transition-all ${
                    selectedAnswers[currentQuestion] === idx + 1
                      ? 'border-indigo-500 bg-indigo-50'
                      : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <div className={`size-5 rounded-full border-2 flex items-center justify-center ${
                      selectedAnswers[currentQuestion] === idx + 1
                        ? 'border-indigo-500 bg-indigo-500'
                        : 'border-gray-300'
                    }`}>
                      {selectedAnswers[currentQuestion] === idx + 1 && (
                        <div className="size-2 rounded-full bg-white" />
                      )}
                    </div>
                    <span className={selectedAnswers[currentQuestion] === idx + 1 ? 'text-indigo-700' : ''}>
                      {answer}
                    </span>
                  </div>
                </button>
              ))}
            </div>
          </CardContent>
        </Card>

        {/* Navigation */}
        <div className="flex gap-4">
          <Button
            variant="outline"
            onClick={handlePrevious}
            disabled={currentQuestion === 0}
            className="flex-1"
          >
            Назад
          </Button>
          
          {currentQuestion < 69 ? (
            <Button
              onClick={handleNext}
              className="flex-1"
            >
              Далее
            </Button>
          ) : (
            <Button
              onClick={completeTest}
              className="flex-1 bg-green-600 hover:bg-green-700"
            >
              Завершить тест
            </Button>
          )}
        </div>

        {/* Progress dots */}
        <div className="flex justify-center gap-1 flex-wrap">
          {Array.from({ length: 70 }).map((_, idx) => (
            <div
              key={idx}
              onClick={() => setCurrentQuestion(idx)}
              className={`size-2 rounded-full transition-all cursor-pointer ${
                selectedAnswers[idx] > 0
                  ? 'bg-green-500'
                  : idx === currentQuestion
                  ? 'bg-indigo-500 scale-125'
                  : 'bg-gray-300'
              }`}
            />
          ))}
        </div>
      </div>
    </div>
  );
}
